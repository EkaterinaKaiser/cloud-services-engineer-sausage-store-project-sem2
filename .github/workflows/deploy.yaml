name: Build and Deploy Sausage Store

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME_BACKEND: sausage-store-backend
  IMAGE_NAME_FRONTEND: sausage-store-frontend
  IMAGE_NAME_BACKEND_REPORT: sausage-store-backend-report

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }}
        tags: |
          type=raw,value=latest

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_FRONTEND }}
        tags: |
          type=raw,value=latest

    - name: Extract metadata for backend-report
      id: meta-backend-report
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND_REPORT }}
        tags: |
          type=raw,value=latest

    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        build-args: |
          VERSION=${{ github.sha }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}

    - name: Build and push backend-report image
      uses: docker/build-push-action@v4
      with:
        context: ./backend-report
        push: true
        tags: ${{ steps.meta-backend-report.outputs.tags }}
        labels: ${{ steps.meta-backend-report.outputs.labels }}

  # deploy:
  #   needs: build-and-push
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3

  #   - name: Set up kubectl
  #     uses: azure/setup-kubectl@v3
  #     with:
  #       version: 'latest'

  #   - name: Configure kubectl
  #     run: |
  #       mkdir -p ~/.kube
  #       echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
  #       chmod 600 ~/.kube/config

  #   - name: Deploy to Kubernetes
  #     run: |
  #       # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –≤ Helm values
  #       sed -i "s|repository: .*|repository: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }}|g" sausage-store-chart/values.yaml
  #       sed -i "s|tag: .*|tag: ${{ github.sha }}|g" sausage-store-chart/values.yaml
  #       
  #       # –í—ã–ø–æ–ª–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
  #       echo "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
  #       # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π —á–µ—Ä–µ–∑ kubectl –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π job
  #       
  #       # –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Helm
  #       helm upgrade --install sausage-store ./sausage-store-chart \
  #         --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }} \
  #         --set backend.image.tag=${{ github.sha }} \
  #         --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_FRONTEND }} \
  #         --set frontend.image.tag=${{ github.sha }} \
  #         --set backend-report.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND_REPORT }} \
  #         --set backend-report.image.tag=${{ github.sha }}

  #   - name: Run database migrations
  #     run: |
  #       # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π pod –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
  #       kubectl run migration-pod --image=postgres:13 --rm -i --restart=Never -- \
  #         psql -h postgres-service -U postgres -d sausage_store -f /migrations/V001__create_tables.sql
  #       # –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏

  add_helm_chart_to_nexus:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Update Helm dependencies
      run: |
        cd sausage-store-chart
        helm dependency update
        helm dependency build

    - name: Package Helm chart
      run: |
        helm package sausage-store-chart/
        ls -la *.tgz

    - name: Upload chart to Nexus
      run: |
        curl -u ${{ secrets.NEXUS_HELM_REPO_USER }}:${{ secrets.NEXUS_HELM_REPO_PASSWORD }} \
          --upload-file sausage-store-chart-*.tgz \
          ${{ secrets.NEXUS_HELM_REPO }}/sausage-store-chart-$(date +%Y%m%d%H%M%S).tgz

  deploy_helm_chart_to_kubernetes:
    needs: add_helm_chart_to_nexus
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Add Nexus Helm repository
      run: |
        helm repo add nexus ${{ secrets.NEXUS_HELM_REPO }} --username ${{ secrets.NEXUS_HELM_REPO_USER }} --password ${{ secrets.NEXUS_HELM_REPO_PASSWORD }}
        helm repo update

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: Clean up existing resources
      run: |
        echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ Kubernetes..."
        
        # –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–ª–∏–∑ Helm, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        helm uninstall sausage-store || echo "–†–µ–ª–∏–∑ sausage-store –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ä–µ—Å—É—Ä—Å—ã —Å –Ω–∞—à–∏–º–∏ –ª–µ–π–±–ª–∞–º–∏
        kubectl delete deployment,service,ingress,configmap,secret,pvc,hpa,vpa,job --selector=app.kubernetes.io/part-of=sausage-store --ignore-not-found=true || true
        kubectl delete deployment,service,ingress,configmap,secret,pvc,hpa,vpa,job --selector=app=sausage-store --ignore-not-found=true || true
        
        # –£–¥–∞–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã –ø–æ –∏–º–µ–Ω–∞–º
        kubectl delete deployment postgresql mongodb || true
        kubectl delete service postgresql-service mongodb-service || true
        kubectl delete job mongodb-init-job || true
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤..."
        sleep 30
        
        echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

    - name: Deploy to Kubernetes
      run: |
        helm upgrade --install sausage-store nexus/sausage-store-chart \
          --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-backend \
          --set backend.image.tag=latest \
          --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-frontend \
          --set frontend.image.tag=latest \
          --set backend-report.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-backend-report \
          --set backend-report.image.tag=latest \
          --wait --timeout=300s

    - name: Verify deployment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–µ–ø–ª–æ—è..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤
        kubectl get pods -l app.kubernetes.io/part-of=sausage-store
        kubectl get pods -l app=sausage-store
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–∏—Å—ã
        kubectl get services -l app.kubernetes.io/part-of=sausage-store
        kubectl get services -l app=sausage-store
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Ingress
        kubectl get ingress
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Helm —Ä–µ–ª–∏–∑–∞
        helm status sausage-store
        
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"