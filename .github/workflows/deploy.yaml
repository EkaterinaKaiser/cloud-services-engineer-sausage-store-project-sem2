name: Build and Deploy Sausage Store

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOCKER_REGISTRY: docker.io
  IMAGE_NAME_BACKEND: sausage-store-backend
  IMAGE_NAME_FRONTEND: sausage-store-frontend
  IMAGE_NAME_BACKEND_REPORT: sausage-store-backend-report

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract metadata for backend
      id: meta-backend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }}
        tags: |
          type=raw,value=latest

    - name: Extract metadata for frontend
      id: meta-frontend
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_FRONTEND }}
        tags: |
          type=raw,value=latest

    - name: Extract metadata for backend-report
      id: meta-backend-report
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND_REPORT }}
        tags: |
          type=raw,value=latest

    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        labels: ${{ steps.meta-backend.outputs.labels }}
        build-args: |
          VERSION=${{ github.sha }}

    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        labels: ${{ steps.meta-frontend.outputs.labels }}

    - name: Build and push backend-report image
      uses: docker/build-push-action@v4
      with:
        context: ./backend-report
        push: true
        tags: ${{ steps.meta-backend-report.outputs.tags }}
        labels: ${{ steps.meta-backend-report.outputs.labels }}

  # deploy:
  #   needs: build-and-push
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3

  #   - name: Set up kubectl
  #     uses: azure/setup-kubectl@v3
  #     with:
  #       version: 'latest'

  #   - name: Configure kubectl
  #     run: |
  #       mkdir -p ~/.kube
  #       echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
  #       chmod 600 ~/.kube/config

  #   - name: Deploy to Kubernetes
  #     run: |
  #       # Обновляем образы в Helm values
  #       sed -i "s|repository: .*|repository: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }}|g" sausage-store-chart/values.yaml
  #       sed -i "s|tag: .*|tag: ${{ github.sha }}|g" sausage-store-chart/values.yaml
  #       
  #       # Выполняем миграции базы данных
  #       echo "Выполнение миграций базы данных..."
  #       # Здесь можно добавить выполнение миграций через kubectl или отдельный job
  #       
  #       # Деплой через Helm
  #       helm upgrade --install sausage-store ./sausage-store-chart \
  #         --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND }} \
  #         --set backend.image.tag=${{ github.sha }} \
  #         --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_FRONTEND }} \
  #         --set frontend.image.tag=${{ github.sha }} \
  #         --set backend-report.image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME_BACKEND_REPORT }} \
  #         --set backend-report.image.tag=${{ github.sha }}

  #   - name: Run database migrations
  #     run: |
  #       # Создаем временный pod для выполнения миграций
  #       kubectl run migration-pod --image=postgres:13 --rm -i --restart=Never -- \
  #         psql -h postgres-service -U postgres -d sausage_store -f /migrations/V001__create_tables.sql
  #       # Добавить остальные миграции по аналогии

  add_helm_chart_to_nexus:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Update Helm dependencies
      run: |
        cd sausage-store-chart
        echo "Обновление зависимостей Helm..."
        helm dependency update
        helm dependency build
        echo "Зависимости обновлены"
        echo "Список зависимостей:"
        helm dependency list

    - name: Package Helm chart
      run: |
        echo "Упаковка Helm чарта..."
        helm package sausage-store-chart/
        echo "Список созданных файлов:"
        ls -la *.tgz
        echo "Содержимое рабочей директории:"
        ls -la

    - name: Upload chart to Nexus
      run: |
        echo "Загрузка чарта в Nexus..."
        CHART_FILE=$(ls sausage-store-*.tgz | head -n1)
        if [ -z "$CHART_FILE" ]; then
          echo "Ошибка: Файл чарта не найден!"
          echo "Доступные файлы:"
          ls -la *.tgz || echo "Нет .tgz файлов"
          exit 1
        fi
        echo "Найден файл чарта: $CHART_FILE"
        curl -u ${{ secrets.NEXUS_HELM_REPO_USER }}:${{ secrets.NEXUS_HELM_REPO_PASSWORD }} \
          --upload-file "$CHART_FILE" \
          ${{ secrets.NEXUS_HELM_REPO }}/sausage-store-chart-$(date +%Y%m%d%H%M%S).tgz

  deploy_helm_chart_to_kubernetes:
    needs: add_helm_chart_to_nexus
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: '3.12.0'

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Add Nexus Helm repository
      run: |
        helm repo add nexus ${{ secrets.NEXUS_HELM_REPO }} --username ${{ secrets.NEXUS_HELM_REPO_USER }} --password ${{ secrets.NEXUS_HELM_REPO_PASSWORD }}
        helm repo update

    - name: Configure kubectl
      run: |
        mkdir -p ~/.kube
        echo "Настройка kubectl..."
        
        # Устанавливаем переменную окружения для всех команд
        export KUBECONFIG_CONTENT="${{ secrets.KUBE_CONFIG }}"
        
        # Способ 1: Использование переменной окружения KUBECONFIG
        echo "Попытка 1: Использование переменной окружения..."
        export KUBECONFIG="$KUBECONFIG_CONTENT"
        if kubectl cluster-info >/dev/null 2>&1; then
          echo "Успешно подключились (переменная окружения)"
          kubectl cluster-info
          exit 0
        fi
        
        # Способ 1.5: Создание временного файла и использование переменной
        echo "Попытка 1.5: Временный файл + переменная окружения..."
        TEMP_KUBECONFIG="/tmp/kubeconfig_temp"
        echo "$KUBECONFIG_CONTENT" > "$TEMP_KUBECONFIG"
        chmod 600 "$TEMP_KUBECONFIG"
        export KUBECONFIG="$TEMP_KUBECONFIG"
        if kubectl cluster-info >/dev/null 2>&1; then
          echo "Успешно подключились (временный файл + переменная)"
          kubectl cluster-info
          rm -f "$TEMP_KUBECONFIG"
          exit 0
        fi
        
        # Способ 2: Прямое создание файла
        echo "Попытка 2: Создание файла kubeconfig..."
        echo "$KUBECONFIG_CONTENT" > ~/.kube/config
        chmod 600 ~/.kube/config
        
        if kubectl cluster-info >/dev/null 2>&1; then
          echo "Успешно подключились (прямое создание файла)"
          kubectl cluster-info
          exit 0
        fi
        
        # Способ 3: Декодирование base64
        echo "Попытка 3: Декодирование base64..."
        if echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config 2>/dev/null; then
          chmod 600 ~/.kube/config
          if kubectl cluster-info >/dev/null 2>&1; then
            echo "Успешно подключились (base64)"
            kubectl cluster-info
            exit 0
          fi
        fi
        
        # Способ 4: Очистка и повторная попытка
        echo "Попытка 4: Очистка и повторная попытка..."
        # Убираем лишние пробелы и переносы строк
        echo "$KUBECONFIG_CONTENT" | sed 's/^[[:space:]]*//' | grep -v '^$' > ~/.kube/config
        chmod 600 ~/.kube/config
        
        if kubectl cluster-info >/dev/null 2>&1; then
          echo "Успешно подключились (очистка)"
          kubectl cluster-info
          exit 0
        fi
        
        # Способ 5: Проверка структуры kubeconfig
        echo "Попытка 5: Анализ структуры kubeconfig..."
        echo "Проверка наличия обязательных полей:"
        echo "- apiVersion: $(grep -c 'apiVersion:' ~/.kube/config || echo '0')"
        echo "- kind: $(grep -c 'kind:' ~/.kube/config || echo '0')"
        echo "- clusters: $(grep -c 'clusters:' ~/.kube/config || echo '0')"
        echo "- contexts: $(grep -c 'contexts:' ~/.kube/config || echo '0')"
        echo "- users: $(grep -c 'users:' ~/.kube/config || echo '0')"
        echo "- current-context: $(grep -c 'current-context:' ~/.kube/config || echo '0')"
        
        # Проверка валидности YAML
        if command -v yq >/dev/null 2>&1; then
          echo "Проверка YAML с помощью yq:"
          yq eval '.' ~/.kube/config >/dev/null 2>&1 && echo "YAML валиден" || echo "YAML невалиден"
        fi
        
        echo "Не удалось подключиться к кластеру ни одним способом"
        echo "Проверка содержимого kubeconfig:"
        echo "Размер файла: $(wc -c < ~/.kube/config) байт"
        echo "Первые 10 строк (без чувствительных данных):"
        head -10 ~/.kube/config | sed 's/certificate-authority-data: .*/certificate-authority-data: [HIDDEN]/' | sed 's/client-certificate-data: .*/client-certificate-data: [HIDDEN]/' | sed 's/client-key-data: .*/client-key-data: [HIDDEN]/'
        echo "Последние 10 строк (без чувствительных данных):"
        tail -10 ~/.kube/config | sed 's/certificate-authority-data: .*/certificate-authority-data: [HIDDEN]/' | sed 's/client-certificate-data: .*/client-certificate-data: [HIDDEN]/' | sed 's/client-key-data: .*/client-key-data: [HIDDEN]/'
        echo "Проверка существования kubeconfig:"
        if [ -f ~/.kube/config ]; then
          echo "Файл kubeconfig существует"
          echo "Проверка синтаксиса YAML:"
          kubectl --kubeconfig=~/.kube/config get nodes --dry-run 2>&1 || kubectl --kubeconfig=~/.kube/config get nodes --dry-run=client 2>&1 || true
          echo "Проверка доступности API сервера:"
          kubectl --kubeconfig=~/.kube/config cluster-info --request-timeout=10s 2>&1 || kubectl cluster-info --request-timeout=10s 2>&1 || true
        else
          echo "Файл kubeconfig не существует"
          echo "Проверка переменной KUBECONFIG:"
          echo "KUBECONFIG=$KUBECONFIG"
          echo "Проверка доступности API сервера без файла:"
          kubectl cluster-info --request-timeout=10s 2>&1 || true
        fi
        echo "Проверка версии kubectl:"
        kubectl version --client
        exit 1

    - name: Clean up existing resources
      run: |
        echo "Очистка существующих ресурсов в Kubernetes..."
        
        # Удаляем существующий релиз Helm, если он есть
        helm uninstall sausage-store || echo "Релиз sausage-store не найден"
        
        # Удаляем все ресурсы с нашими лейблами
        kubectl delete deployment,service,ingress,configmap,secret,pvc,hpa,vpa,job --selector=app.kubernetes.io/part-of=sausage-store --ignore-not-found=true || true
        kubectl delete deployment,service,ingress,configmap,secret,pvc,hpa,vpa,job --selector=app=sausage-store --ignore-not-found=true || true
        
        # Удаляем ресурсы по именам
        kubectl delete deployment postgresql mongodb || true
        kubectl delete service postgresql-service mongodb-service || true
        kubectl delete job mongodb-init-job || true
        
        # Ждем завершения удаления
        echo "Ожидание завершения удаления ресурсов..."
        sleep 30
        
        echo "Очистка завершена"

    - name: Deploy to Kubernetes
      run: |
        helm upgrade --install sausage-store nexus/sausage-store-chart \
          --set backend.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-backend \
          --set backend.image.tag=latest \
          --set frontend.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-frontend \
          --set frontend.image.tag=latest \
          --set backend-report.image.repository=${{ secrets.DOCKER_USERNAME }}/sausage-store-backend-report \
          --set backend-report.image.tag=latest \
          --wait --timeout=300s

    - name: Verify deployment
      run: |
        echo "Проверка статуса деплоя..."
        
        # Проверяем статус подов
        kubectl get pods -l app.kubernetes.io/part-of=sausage-store
        kubectl get pods -l app=sausage-store
        
        # Проверяем сервисы
        kubectl get services -l app.kubernetes.io/part-of=sausage-store
        kubectl get services -l app=sausage-store
        
        # Проверяем Ingress
        kubectl get ingress
        
        # Проверяем статус Helm релиза
        helm status sausage-store
        
        echo "Деплой завершен успешно!"